name: Build Native POSIX

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: build-native-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-native-posix:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: GreenEdge

      - name: Cache west modules
        uses: actions/cache@v3
        with:
          path: |
            GreenEdge/deps
            GreenEdge/.west
          key: west-${{ hashFiles('GreenEdge/west.yml') }}
          restore-keys: |
            zephyr-modules-

      # - name: Cache Zephyr SDK
      #   uses: actions/cache@v3
      #   with:
      #     path: ~/zephyr-sdk-0.17.4
      #     key: zephyr-sdk-0.17.4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git cmake ninja-build gperf \
            ccache dfu-util device-tree-compiler wget \
            python3-dev python3-pip python3-setuptools python3-tk python3-wheel \
            xz-utils file make gcc gcc-multilib g++-multilib libsdl2-dev libmagic1

      - name: Setup Python virtual environment
        run: |
          python3 -m venv ~/zephyr-env
          source ~/zephyr-env/bin/activate
          pip install west

      - name: Initialize west workspace
        run: |
          source ~/zephyr-env/bin/activate
          cd GreenEdge
          if [ -d .west ]; then
            echo ".west exists, skipping init"
          else
            west init -l .
          fi

          west update
          west zephyr-export

      - name: Install Zephyr Python dependencies
        run: |
          source ~/zephyr-env/bin/activate
          cd GreenEdge
          west packages pip --install

      # - name: Setup Zephyr SDK
      #   run: |
      #     cd ~
      #     wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.17.4/zephyr-sdk-0.17.4_linux-x86_64.tar.xz
      #     tar xf zephyr-sdk-0.17.4_linux-x86_64.tar.xz
      #     cd zephyr-sdk-0.17.4
      #     ./setup.sh -t all -h -c

      - name: Build for native_posix
        run: |
          source ~/zephyr-env/bin/activate
          cd GreenEdge
          west build -p auto -b native_posix -- -DCONFIG_COVERAGE=y

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GreenEdge-native-posix
          path: |
            GreenEdge/build/zephyr/zephyr.exe
            GreenEdge/build/zephyr/zephyr.elf
          retention-days: 30

      - name: Save build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-native-posix
          path: GreenEdge/build/build.log
          retention-days: 7
