name: Build Native POSIX

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: build-native-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-native-posix:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: GreenEdge

      - name: Free Disk Space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo "Disk space after cleanup:"
          df -h

      - name: Cache west modules
        uses: actions/cache@v3
        with:
          path: |
            GreenEdge/deps
            GreenEdge/.west
          key: west-${{ hashFiles('GreenEdge/west.yml') }}
          restore-keys: |
            west-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git cmake ninja-build gperf \
            ccache dfu-util device-tree-compiler wget \
            python3-dev python3-pip python3-setuptools python3-tk python3-wheel \
            xz-utils file make gcc gcc-multilib g++-multilib libsdl2-dev libmagic1

      - name: Setup Python virtual environment
        run: |
          python3 -m venv ~/zephyr-env
          source ~/zephyr-env/bin/activate
          pip install west

      - name: Initialize west workspace
        run: |
          source ~/zephyr-env/bin/activate
          cd GreenEdge
          
          if [ -d .west ]; then
            echo " .west exists (from cache), skipping init"
          else
            echo " Initializing west workspace"
            west init -l .
          fi
          
          echo " Updating west modules"
          west update
          
          echo " Exporting Zephyr environment"
          west zephyr-export

      - name: Install Zephyr Python dependencies
        run: |
          source ~/zephyr-env/bin/activate
          cd GreenEdge
          west packages pip --install

      - name: Setup Zephyr SDK
        run: |
          if [ ! -d ~/zephyr-sdk-0.17.4 ]; then
            cd ~
            wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.17.4/zephyr-sdk-0.17.4_linux-x86_64.tar.xz
            tar xf zephyr-sdk-0.17.4_linux-x86_64.tar.xz
            cd zephyr-sdk-0.17.4
            ./setup.sh -t all -h -c
          fi

      - name: Build for native_sim
        run: |
          source ~/zephyr-env/bin/activate
          cd GreenEdge/app
          west build -p auto -b native_sim -- -DCONFIG_COVERAGE=y

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GreenEdge-native-sim
          path: |
            GreenEdge/app/build/zephyr/zephyr.exe
            GreenEdge/app/build/zephyr/zephyr.elf
          retention-days: 30

      - name: Save build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-native-sim
          path: GreenEdge/app/build/build.log
          retention-days: 7
